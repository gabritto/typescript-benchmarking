steps:
  - checkout: self
    path: typescript-benchmarking
    fetchTags: false
    fetchDepth: 1
    clean: true
    retryCountOnTaskFailure: 3

  - task: Cache@2
    inputs:
      key: '"pnpm" | "$(Agent.OS)" | $(Pipeline.Workspace)/typescript-benchmarking/pnpm-lock.yaml'
      restoreKeys: |
        "pnpm" | "$(Agent.OS)"
      path: $(Pipeline.Workspace)/.pnpm-store
    displayName: Cache pnpm

  - script: |
      corepack enable
      corepack prepare pnpm@latest-8 --activate
      pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
    displayName: 'Setup pnpm'

  # TODO(jakebailey): install correct version of pnpm
  - bash: |
      set -eo pipefail
      cd $(Pipeline.Workspace)/typescript-benchmarking
      pnpm install
    displayName: Install typescript-benchmarking
    retryCountOnTaskFailure: 3

  - bash: |
      set -eo pipefail
      cd $(Pipeline.Workspace)/typescript-benchmarking
      pnpm build
    displayName: Build typescript-benchmarking

  - bash: |
      echo "##vso[task.setvariable variable=BENCH_SCRIPTS]$(Pipeline.Workspace)/typescript-benchmarking/scripts"
      # TODO: we can resolve this directly from the scripts dir now
      echo "##vso[task.setvariable variable=TSPERF_EXE]$(Pipeline.Workspace)/typescript-benchmarking/ts-perf/bin/ts-perf"
    displayName: Set typescript-benchmarking variables
